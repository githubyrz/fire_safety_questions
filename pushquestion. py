# send_question.py
import json
import random
import requests
import os

# ä»ç¯å¢ƒå˜é‡è·å–Webhookåœ°å€
webhook_url = os.getenv('WECHAT_WEBHOOK_URL')

# 1. è¯»å–é¢˜åº“
with open('questions.json', 'r', encoding='utf-8') as f:
    all_questions = json.load(f)

# 2. éšæœºé€‰æ‹©ä¸€é“é¢˜
selected_question = random.choice(all_questions)

# 3. æ„å»ºä¼ä¸šå¾®ä¿¡æœºå™¨äººæ”¯æŒçš„æ¶ˆæ¯æ ¼å¼ (Markdown)
msg_content = f"""## ğŸ“š æ¯æ—¥ä¸€é¢˜

**é¢˜ç›®ï¼š** {selected_question['question']}

"""
for option in selected_question['options']:
    msg_content += f"\n- {option}"

msg_content += f"\n\n<font color=\"comment\">æç¤ºï¼šç­”æ¡ˆå°†åœ¨ä¸‹æœŸæˆ–ç¨åå…¬å¸ƒã€‚</font>"

# ä¼ä¸šå¾®ä¿¡æœºå™¨äººè¦æ±‚çš„æ¶ˆæ¯ç»“æ„
data = {
    "msgtype": "markdown",
    "markdown": {
        "content": msg_content
    }
}

# 4. é€šè¿‡Webhookå‘é€
response = requests.post(
    webhook_url,
    headers={'Content-Type': 'application/json'},
    json=data,
    timeout=10  # è®¾ç½®è¶…æ—¶
)

# æ£€æŸ¥å‘é€ç»“æœ
if response.json().get('errcode') == 0:
    print("é¢˜ç›®å‘é€æˆåŠŸï¼")
else:
    print(f"å‘é€å¤±è´¥: {response.text}")
    # å¤±è´¥æ—¶è®©GitHub Actionæ„ŸçŸ¥åˆ°ä»»åŠ¡å¤±è´¥
    exit(1)